name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Check formatting
        run: |
          FILES=$(gofmt -l .)
          if [ -n "$FILES" ]; then
            echo "The following files are not formatted:"
            echo "$FILES"
            exit 1
          fi

      - name: Vet
        run: go vet ./...

      - name: Unit test + coverage
        run: |
          go list ./... | grep -v '^transblog/e2e$' | xargs go test -covermode=atomic -coverprofile=coverage.out

          TOTAL=$(go tool cover -func=coverage.out | awk '/^total:/ {gsub("%", "", $3); print $3}')
          THRESHOLD=45
          awk -v total="$TOTAL" -v threshold="$THRESHOLD" 'BEGIN {
            if ((total + 0) < threshold) {
              printf("coverage %.2f%% is below threshold %d%%\n", total + 0, threshold)
              exit 1
            }
          }'

      - name: Integration tests (e2e)
        run: go test ./e2e -count=1

      - name: Build
        run: go build ./cmd/transblog
